version: '3.8'

services:
  # ============================================
  # INFRASTRUCTURE SERVICES
  # ============================================

  # MySQL Database - for User, Order, Payment services
  mysql:
    image: mysql:8.0
    container_name: ecommerce-mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootsecret}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-ecommerce}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB - for Product and Analytics services
  mongodb:
    image: mongo:7
    container_name: ecommerce-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-rootsecret}
    volumes:
      - mongodb_data:/data/db
      - ./docker/mongodb/init/01-init.sh:/docker-entrypoint-initdb.d/01-init.sh:ro
    networks:
      - ecommerce-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ - Message broker for all services
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: ecommerce-rabbitmq
    ports:
      - "5672:5672"   # AMQP protocol
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-secret}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - ecommerce-network
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 30s
      timeout: 10s
      retries: 5

  # Redis - Caching and session storage
  redis:
    image: redis:7-alpine
    container_name: ecommerce-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # APPLICATION SERVICES
  # ============================================

  # User Service - User management & authentication
  user-service:
    image: webdevops/php-nginx:8.3-alpine
    container_name: user-service
    ports:
      - "8001:80"
    environment:
      WEB_DOCUMENT_ROOT: /app/public
      PHP_DISPLAY_ERRORS: 1
      PHP_MEMORY_LIMIT: 512M
      # Database
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: user_service
      DB_USERNAME: root
      DB_PASSWORD: rootsecret
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # RabbitMQ
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: admin
      RABBITMQ_PASSWORD: secret
      # Queue
      QUEUE_CONNECTION: sync
    volumes:
      - ./services/user-service:/app
    networks:
      - ecommerce-network
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  # Product Service - Product catalog & management
  product-service:
    build:
      context: ./services/product-service
      dockerfile: Dockerfile
    container_name: product-service
    ports:
      - "8002:80"
    volumes:
      - ./services/product-service:/app
    environment:
      WEB_DOCUMENT_ROOT: /app/public
      PHP_DISPLAY_ERRORS: 1
      PHP_MEMORY_LIMIT: 512M
      # Database
      DB_CONNECTION: mongodb
      DB_HOST: mongodb
      DB_PORT: 27017
      DB_DATABASE: products
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # RabbitMQ
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: admin
      RABBITMQ_PASSWORD: secret
      # Queue
      QUEUE_CONNECTION: sync
    networks:
      - ecommerce-network
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy

  # PostgreSQL Database - for Order Service
  postgres:
    image: postgres:16-alpine
    container_name: ecommerce-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: orders
      POSTGRES_USER: orderuser
      POSTGRES_PASSWORD: ordersecret
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - ecommerce-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U orderuser -d orders"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Order Service - Order management
  order-service:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    container_name: order-service
    ports:
      - "8003:80"
    volumes:
      - ./services/order-service:/app
    environment:
      WEB_DOCUMENT_ROOT: /app/public
      PHP_DISPLAY_ERRORS: 1
      PHP_MEMORY_LIMIT: 512M
      # Database
      DB_CONNECTION: pgsql
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: orders
      DB_USERNAME: orderuser
      DB_PASSWORD: ordersecret
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # RabbitMQ
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: admin
      RABBITMQ_PASSWORD: secret
      # Queue
      QUEUE_CONNECTION: sync
      # External Services
      USER_SERVICE_URL: http://user-service
      PRODUCT_SERVICE_URL: http://product-service
    networks:
      - ecommerce-network
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy

  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: notification-service
    ports:
      - "8005:80"
    volumes:
      - ./services/notification-service:/app
    networks:
      - ecommerce-network
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      WEB_DOCUMENT_ROOT: /app/public
      PHP_DISPLAY_ERRORS: 1
      PHP_MEMORY_LIMIT: 512M
      APP_ENV: local
      APP_DEBUG: true
      LOG_CHANNEL: stack
      # RabbitMQ
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: admin
      RABBITMQ_PASSWORD: secret
      # Queue
      QUEUE_CONNECTION: sync

  # Payment Service - Payment processing
  payment-service:
    build:
      context: ./services/payment-service
      dockerfile: Dockerfile
    container_name: payment-service
    ports:
      - "8004:8004"
    networks:
      - ecommerce-network
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/payment_service?createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: rootsecret
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: admin
      SPRING_RABBITMQ_PASSWORD: secret
# ============================================
# NETWORKS
# ============================================
networks:
  ecommerce-network:
    driver: bridge
    name: ecommerce-network

# ============================================
# VOLUMES
# ============================================
volumes:
  mysql_data:
    name: ecommerce-mysql-data
  mongodb_data:
    name: ecommerce-mongodb-data
  rabbitmq_data:
    name: ecommerce-rabbitmq-data
  redis_data:
    name: ecommerce-redis-data
  postgres_data:
    name: ecommerce-postgres-data